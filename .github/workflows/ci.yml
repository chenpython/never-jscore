name: CI

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: full
  GH_ACTIONS: 1

jobs:
  # Rust 代码检查
  lint:
    name: Lint (rustfmt + clippy)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "lint"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libclang-dev clang

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        env:
          RUSTFLAGS: -D warnings

  # 快速测试（不从源码编译 V8）
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.11', '3.13']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "test-py${{ matrix.python-version }}"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libclang-dev clang cmake

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install maturin pytest

      - name: Build package (development mode)
        run: |
          # 使用预编译 V8 以加速 CI 测试
          export V8_FROM_SOURCE=0
          maturin develop --release

      - name: Run Python tests
        run: |
          echo "=== Running async tests ==="
          python test_async_simple.py

          echo "=== Running extension tests ==="
          python test_extensions.py

          echo "=== Running new API tests ==="
          python test_new_apis.py

          echo "=== Running example tests ==="
          python examples/test.py

      - name: Run benchmark (smoke test)
        run: |
          echo "=== Running benchmark smoke test ==="
          python examples/benchmark.py

  # 构建文档检查
  docs:
    name: Check documentation
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "docs"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libclang-dev clang

      - name: Check documentation
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: "-D warnings"

  # 安全审计
  security:
    name: Security audit
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit --deny warnings
